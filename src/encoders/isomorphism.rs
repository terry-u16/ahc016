use self::{
    annealing::{binarygraph::BinaryGraph, state::State},
    checker::{try_generate_isompic_graphs, IsomophicChecker, Vf2Checker},
};
use super::Encoder;
use crate::{
    encoders::isomorphism::annealing::annealer::Annealer,
    graph::Graph,
    utils::{decode_num_to_u64, ChangeMinMax},
};
use rand_pcg::Pcg64Mcg;

mod annealing;
mod checker;

#[derive(Debug, Clone)]
pub struct IsomorphismEncoder {
    graphs: Vec<Graph>,
    /// 送信するグラフの種類数
    graph_count: usize,
    /// グラフの大きさ
    graph_size: usize,
    /// 冗長性考慮前のグラフの大きさ
    original_graph_size: usize,
    /// 冗長性
    redundancy: usize,
    /// 焼きなましスコアのグループ内:グループ外の重みの比
    score_coef: f64,
}

impl IsomorphismEncoder {
    pub fn new(
        graph_count: usize,
        error_ratio: f64,
        bits: Option<usize>,
        redundancy: Option<usize>,
        score_coef: Option<f64>,
    ) -> Self {
        let (auto_bits, auto_redundancy, auto_score_coef) =
            Self::get_storategy(graph_count, error_ratio);

        let (mut graphs, original_graph_size) = if let Some(bits) = bits {
            (
                try_generate_isompic_graphs(graph_count, error_ratio, bits).unwrap(),
                bits,
            )
        } else {
            (
                try_generate_isompic_graphs(graph_count, error_ratio, auto_bits).unwrap(),
                auto_bits,
            )
        };

        graphs.truncate(graph_count);
        let redundancy = redundancy.unwrap_or(auto_redundancy);
        let score_coef = score_coef.unwrap_or(auto_score_coef);
        let graph_size = original_graph_size * redundancy;

        Self {
            graphs,
            graph_count,
            graph_size,
            original_graph_size,
            redundancy,
            score_coef,
        }
    }

    fn get_storategy(m: usize, error_ratio: f64) -> (usize, usize, f64) {
        let error_ratio = (error_ratio * 100.0 + 0.1) as usize;
        let storategy_matrix = get_storategy_matrix();
        storategy_matrix[m - 10][error_ratio]
    }

    fn restore(
        &self,
        graph: &BinaryGraph,
        annealer: &Annealer,
        duration: f64,
        rng: &mut Pcg64Mcg,
    ) -> Option<usize> {
        let state = State::init_rand(&graph, self.original_graph_size, self.score_coef, rng);
        let state = annealer.annealing(&graph, state, duration);
        let graph = state.restore_graph();
        let checker = Vf2Checker::new(&graph);

        for (i, g) in self.graphs.iter().enumerate() {
            if checker.is_isomorphic(g) {
                return Some(i);
            }
        }

        eprintln!("failed to decode.");
        None
    }
}

impl Encoder for IsomorphismEncoder {
    fn graph_size(&self) -> usize {
        self.graph_size
    }

    fn encode(&self, index: usize) -> Graph {
        let original_graph = &self.graphs[index];

        let mut graph = Graph::new(self.graph_size);
        // クリーク内
        for i in 0..original_graph.n {
            for x in 0..self.redundancy {
                for y in (x + 1)..self.redundancy {
                    let u = i * self.redundancy + x;
                    let v = i * self.redundancy + y;
                    graph.connect(u, v);
                }
            }
        }

        // クリーク間
        for i in 0..original_graph.n {
            for j in (i + 1)..original_graph.n {
                for x in 0..self.redundancy {
                    for y in 0..self.redundancy {
                        let u = i * self.redundancy + x;
                        let v = j * self.redundancy + y;
                        if original_graph[i][j] {
                            graph.connect(u, v);
                        }
                    }
                }
            }
        }

        graph
    }

    fn decode(&self, graph: &Graph, duration: f64) -> usize {
        let mut rng = Pcg64Mcg::new(42);
        let graph = BinaryGraph::new(graph);
        let annealer = Annealer::new(false);
        let mut votes = vec![0; self.graph_count];

        const TRIAL_COUNT: usize = 5;
        let each_duration = duration / TRIAL_COUNT as f64;

        // 多数決を取る
        for _ in 0..TRIAL_COUNT {
            if let Some(i) = self.restore(&graph, &annealer, each_duration, &mut rng) {
                votes[i] += 1;
            }
        }

        let mut max_votes = 0;
        let mut max_index = 0;

        for (i, &c) in votes.iter().enumerate() {
            if max_votes.change_max(c) {
                max_index = i;
            }
        }

        max_index
    }
}

fn get_storategy_matrix() -> Vec<Vec<(usize, usize, f64)>> {
    const DEC_DATA: &[u8] = b"4011040110402205021040225403104031040315403154031540410404104043040430405104051040510406104062040720406104071050615408104081040810408104112041010410104111041210412104131041815514104201542315423154251551810401104011040210402104022540210403104031040310404104041040410503205041040510405104052540610406105052040710407104081540810408254091040910409104091041010411105111051220513105172041815519154231542415425154201050110502105021050210502105031050320503205031060320504105041050410504205041050515505155052050610506105061050615507105072550810508105081050910509105101051010513205141551515516155171551915519155201551710520105011050210502105021050210503105032050320503106032050410504105041050420504105051550515505205061050610506105061550710507255081050810508105091050910510105101051320514155151551615517155191551915520155171052010501105021050210502105021050310503205032050310603205041050410504105042050410505155051550520506105061050610506155071050725508105081050810509105091051010510105132051415515155161551715519155191552015517105201050110502105021050210502105031050320503205031060320504105041050410504205041050515505155052050610506105061050615507105072550810508105081050910509105101051010513205141551515516155171551915519155201551710520105011050210502105021050210503105032050320503106032050410504105041050420504105051550515505205061050610506105061550710507255081050810508105091050910510105101051320514155151551615517155191551915520155171052010501105021050210502105021050310503205032050310603205041050410504105042050410505155051550520506105061050610506155071050725508105081050810509105091051010510105132051415515155161551715519155191552015517105201050110502105021050210502105031050320503205031060320504105041050410504205041050515505155052050610506105061050615507105072550810508105081050910509105101051010513205141551515516155171551915519155201551710520105011050210502105021050210503105032050320503106032050410504105041050420504105051550515505205061050610506105061550710507255081050810508105091050910510105101051320514155151551615517155191551915520155171052010501105021050210502105021050310503205032050310603205041050410504105042050410505155051550520506105061050610506155071050725508105081050810509105091051010510105132051415515155161551715519155191552015517105201050110502105021050220502105031050310503205032060315504105042550410504205041550510505105051550610605205061050610506106072050810508105091050910509105101051215514205151551720517155191551915519156161051810520105011050210502105022050210503105031050320503206031550410504255041050420504155051050510505155061060520506105061050610607205081050810509105091050910510105121551420515155172051715519155191551915616105181052010501105021050210502205021050310503105032050320603155041050425504105042050415505105051050515506106052050610506105061060720508105081050910509105091051010512155142051515517205171551915519155191561610518105201050110502105021050220502105031050310503205032060315504105042550410504205041550510505105051550610605205061050610506106072050810508105091050910509105101051215514205151551720517155191551915519156161051810520105011050210502105022050210503105031050320503206031550410504255041050420504155051050510505155061060520506105061050610607205081050810509105091050910510105121551420515155172051715519155191551915616105181052010501105021050220502255022050220503105031050310503105041050410504105041550410504105051550525506105061550715606105071050710509155081050925510255112551315513155142051520615156131051715519155191561610518105191050110502105022050225502205022050310503105031050310504105041050410504155041050410505155052550610506155071560610507105071050915508105092551025511255131551315514205152061515613105171551915519156161051810519105011050210502205022550220502205031050310503105031050410504105041050415504105041050515505255061050615507156061050710507105091550810509255102551125513155131551420515206151561310517155191551915616105181051910501105021050210502105031050310503105031050320603206032050410504305042050415604155052050610506105061060620606106061050810607155092050925509105091051010513155141561415516156161561615616155201551710517105181050110502105021050210503105031050310503105032060320603205041050430504205041560415505205061050610506106062060610606105081060715509205092550910509105101051315514156141551615616156161561615520155171051710518105011050110502205021050310503105031050320503256032060320504105041560410505105052050610506105061050610506105071060610508105081050810509105101551015513206111051315614156151561515616155181552015520155171051810501105021050210502105021050320503205031050310603205041050410504105041050410505155061050610506255061050710606105071050710509105092050910608106091051215513156111061315616156161561615518155191552015518105201050110502105021050210502305031050310503106031050310603105042560410604105051050510505255061050610506105072550715606155071060710608106081050810511155111561215513206131561415616156162061615519155201551910519105011050210502105021050310503106031060320603206032060320603256041560420505105061550610605205061050610606155072550820507105092060810510156081060910609106121561215614156121061615616156161561510520155181051910601106021060220602206031560310603106032060320604106041060410604106041060510605106051060515605206061560615606156062060710607106081060920610106101061125612156141561415616156161561615616156161561610616106161560110602106022060220603156031060310603206032060410604106041060410604106051060510605106051560520606156061560615606206071060710608106092061010610106112561215614156141561615616156161561615616156161061610616156011060210602206022060315603106031060320603206041060410604106041060410605106051060510605156052060615606156061560620607106071060810609206101061010611256121561415614156161561615616156161561615616106161061615601106021060220602206031560310603106032060320604106041060410604106041060510605106051060515605206061560615606156062060710607106081060920610106101061125612156141561415616156161561615616156161561610616106161560110602106022060220603156031060310603206032060410604106041060410604106051060510605106051560520606156061560615606206071060710608106092061010610106112561215614156141561615616156161561615616156161061610616156011060210602206022060315603106031060320603206041060410604106041060410605106051060510605156052060615606156061560620607106071060810609206101061010611256121561415614156161561615616156161561615616106161061615601106022060220602106031060310603206031060310603106032060315604106041560410605106052560525605256062060610606106061060810608106081060810610156112061115611156131561315615206151561615616156161061610616106161060110602206022060210603106031060320603106031060310603206031560410604156041060510605256052560525606206061060610606106081060810608106081061015611206111561115613156131561520615156161561615616106161061610616106011060220602206021060310603106032060310603106031060320603156041060415604106051060525605256052560620606106061060610608106081060810608106101561120611156111561315613156152061515616156161561610616106161061610601106022060220602106031060310603206031060310603106032060315604106041560410605106052560525605256062060610606106061060810608106081060810610156112061115611156131561315615206151561615616156161061610616106161060110602206022060210603106031060320603106031060310603206031560410604156041060510605256052560525606206061060610606106081060810608106081061015611206111561115613156131561520615156161561615616106161061610616106011060220602206021060310603106032060310603106031060320603156041060415604106051060525605256052560620606106061060610608106081060810608106101561120611156111561315613156152061515616156161561610616106161061610601106022060220602106031060310603206031060310603106032060315604106041560410605106052560525605256062060610606106061060810608106081060810610156112061115611156131561315615206151561615616156161061610616106161060110602206022060210603106031060320603106031060310603206031560410604156041060510605256052560525606206061060610606106081060810608106081061015611206111561115613156131561520615156161561615616106161061610616106011060220602206021060310603106032060310603106031060320603156041060415604106051060525605256052560620606106061060610608106081060810608106101561120611156111561315613156152061515616156161561610616106161061610601106022060220602106031060310603206031060310603106032060315604106041560410605106052560525605256062060610606106061060810608106081060810610156112061115611156131561315615206151561615616156161061610616106161060110602106022060220603206031060320603106031060325604106042560420604106042060415605206051560510605156052060610606106081560810608256092561015609106111561010613156151561515615156161561615616106161061610616106011060210602206022060320603106032060310603106032560410604256042060410604206041560520605156051060515605206061060610608156081060825609256101560910611156101061315615156151561515616156161561610616106161061610601106021060220602206032060310603206031060310603256041060425604206041060420604156052060515605106051560520606106061060815608106082560925610156091061115610106131561515615156151561615616156161061610616106161060110602106022060220603206031060320603106031060325604106042560420604106042060415605206051560510605156052060610606106081560810608256092561015609106111561010613156151561515615156161561615616106161061610616106011060210602206022060320603106032060310603106032560410604256042060410604206041560520605156051060515605206061060610608156081060825609256101560910611156101061315615156151561515616156161561610616106161061610601106021060220602206032060310603206031060310603256041060425604206041060420604156052060515605106051560520606106061060815608106082560925610156091061115610106131561515615156151561615616156161061610616106161060110602106022060220603206031060320603106031060325604106042560420604106042060415605206051560510605156052060610606106081560810608256092561015609106111561010613156151561515615156161561615616106161061610616106011060210602206022060320603106032060310603106032560410604256042060410604206041560520605156051060515605206061060610608156081060825609256101560910611156101061315615156151561515616156161561610616106161061610601106021060220602206032060310603206031060310603256041060425604206041060420604156052060515605106051560520606106061060815608106082560925610156091061115610106131561515615156151561615616156161061610616106161060110602106022060220603206031060320603106031060325604106042560420604106042060415605206051560510605156052060610606106081560810608256092561015609106111561010613156151561515615156161561615616106161061610616106011060210602106021560210602106031060310603206041060410604106041060410604156051060510605156052060520606106061060710607106081060810608106091061115611156111561315615206141561615616156151061610616106161061610601106021060210602156021060210603106031060320604106041060410604106041060415605106051060515605206052060610606106071060710608106081060810609106111561115611156131561520614156161561615615106161061610616106161060110602106021060215602106021060310603106032060410604106041060410604106041560510605106051560520605206061060610607106071060810608106081060910611156111561115613156152061415616156161561510616106161061610616106011060210602106021560210602106031060310603206041060410604106041060410604156051060510605156052060520606106061060710607106081060810608106091061115611156111561315615206141561615616156151061610616106161061610601106021060210602156021060210603106031060320604106041060410604106041060415605106051060515605206052060610606106071060710608106081060810609106111561115611156131561520614156161561615615106161061610616106161060110602106021060215602106021060310603106032060410604106041060410604106041560510605106051560520605206061060610607106071060810608106081060910611156111561115613156152061415616156161561510616106161061610616106011060210602106021560210602106031060310603206041060410604106041060410604156051060510605156052060520606106061060710607106081060810608106091061115611156111561315615206141561615616156151061610616106161061610601106021060210602156021060210603106031060320604106041060410604106041060415605106051060515605206052060610606106071060710608106081060810609106111561115611156131561520614156161561615615106161061610616106161060110602106021060215602106021060310603106032060410604106041060410604106041560510605106051560520605206061060610607106071060810608106081060910611156111561115613156152061415616156161561510616106161061610616106011060210602106021560210602106031060310603206041060410604106041060410604156051060510605156052060520606106061060710607106081060810608106091061115611156111561315615206141561615616156151061610616106161061610601106021060210603106031060325603106031060320603206042060410604106041060420605156061060610606106061560610606106061060810608206081060910609106111561220612156131561520614156161561615615106151061610616106161060110602106021060310603106032560310603106032060320604206041060410604106042060515606106061060610606156061060610606106081060820608106091060910611156122061215613156152061415616156161561510615106161061610616106011060210602106031060310603256031060310603206032060420604106041060410604206051560610606106061060615606106061060610608106082060810609106091061115612206121561315615206141561615616156151061510616106161061610601106021060210603106031060325603106031060320603206042060410604106041060420605156061060610606106061560610606106061060810608206081060910609106111561220612156131561520614156161561615615106151061610616106161060110602106021060310603106032560310603106032060320604206041060410604106042060515606106061060610606156061060610606106081060820608106091060910611156122061215613156152061415616156161561510615106161061610616106011060210602106031060310603256031060310603206032060420604106041060410604206051560610606106061060615606106061060610608106082060810609106091061115612206121561315615206141561615616156151061510616106161061610601106021060210603106031060325603106031060320603206042060410604106041060420605156061060610606106061560610606106061060810608206081060910609106111561220612156131561520614156161561615615106151061610616106161060110602106021060310603106032560310603106032060320604206041060410604106042060515606106061060610606156061060610606106081060820608106091060910611156122061215613156152061415616156161561510615106161061610616106011060210602106031060310603256031060310603206032060420604106041060410604206051560610606106061060615606106061060610608106082060810609106091061115612206121561315615206141561615616156151061510616106161061610601106021060210603106031060325603106031060320603206042060410604106041060420605156061060610606106061560610606106061060810608206081060910609106111561220612156131561520614156161561615615106151061610616106161060110602106021060210603106031060310603206031060310604106041060415604156041060415605106051060610606106061560610607106081060810608106091061015610106112061315614156151561515616156161561615616106161061610616106011060210602106021060310603106031060320603106031060410604106041560415604106041560510605106061060610606156061060710608106081060810609106101561010611206131561415615156151561615616156161561610616106161061610601106021060210602106031060310603106032060310603106041060410604156041560410604156051060510606106061060615606106071060810608106081060910610156101061120613156141561515615156161561615616156161061610616106161060110602106021060210603106031060310603206031060310604106041060415604156041060415605106051060610606106061560610607106081060810608106091061015610106112061315614156151561515616156161561615616106161061610616106011060210602106021060310603106031060320603106031060410604106041560415604106041560510605106061060610606156061060710608106081060810609106101561010611206131561415615156151561615616156161561610616106161061610601106021060210602106031060310603106032060310603106041060410604156041560410604156051060510606106061060615606106071060810608106081060910610156101061120613156141561515615156161561615616156161061610616106161060110602106021060210603106031060310603206031060310604106041060415604156041060415605106051060610606106061560610607106081060810608106091061015610106112061315614156151561515616156161561615616106161061610616106011060210602106021060310603106031060320603106031060410604106041560415604106041560510605106061060610606156061060710608106081060810609106101561010611206131561415615156151561615616156161561610616106161061610601106021060210602106031060310603106032060310603106041060410604156041560410604156051060510606106061060615606106071060810608106081060910610156101061120613156141561515615156161561615616156161061610616106161060110602106021060210603106031060310603206031060310604106041060415604156041060415605106051060610606106061560610607106081060810608106091061015610106112061315614156151561515616156161561615616106161061610616106011060210602106021060310603106031060320603106031060320604106041060410604106041060525605206052560620606106071060710608156081560810609106101561115612156122061315615156151561515616156151061610616106161061615601106021060210602106031060310603106032060310603106032060410604106041060410604106052560520605256062060610607106071060815608156081060910610156111561215612206131561515615156151561615615106161061610616106161560110602106021060210603106031060310603206031060310603206041060410604106041060410605256052060525606206061060710607106081560815608106091061015611156121561220613156151561515615156161561510616106161061610616156011060210602106021060310603106031060320603106031060320604106041060410604106041060525605206052560620606106071060710608156081560810609106101561115612156122061315615156151561515616156151061610616106161061615601106021060210602106031060310603106032060310603106032060410604106041060410604106052560520605256062060610607106071060815608156081060910610156111561215612206131561515615156151561615615106161061610616106161560110602106021060210603106031060310603206031060310603206041060410604106041060410605256052060525606206061060710607106081560815608106091061015611156121561220613156151561515615156161561510616106161061610616156011060210602106021060310603106031060320603106031060320604106041060410604106041060525605206052560620606106071060710608156081560810609106101561115612156122061315615156151561515616156151061610616106161061615601106021060210602106031060310603106032060310603106032060410604106041060410604106052560520605256062060610607106071060815608156081060910610156111561215612206131561515615156151561615615106161061610616106161560110602106021060210603106031060310603206031060310603206041060410604106041060410605256052060525606206061060710607106081560815608106091061015611156121561220613156151561515615156161561510616106161061610616156011060210602106021060310603106031060320603106031060320604106041060410604106041060525605206052560620606106071060710608156081560810609106101561115612156122061315615156151561515616156151061610616106161061615";

    let mut matrix = vec![];
    let mut cursor = 0;

    for _m in 10..=100 {
        let mut line = vec![];
        for _eps in 0..=40 {
            let bits = decode_num_to_u64(&DEC_DATA[cursor..(cursor + 1)]) as usize;
            cursor += 1;
            let redundancy = decode_num_to_u64(&DEC_DATA[cursor..(cursor + 2)]) as usize;
            cursor += 2;
            let score_coef = decode_num_to_u64(&DEC_DATA[cursor..(cursor + 2)]) as f64 * 0.1;
            cursor += 2;
            line.push((bits, redundancy, score_coef));
        }
        matrix.push(line)
    }

    matrix
}
