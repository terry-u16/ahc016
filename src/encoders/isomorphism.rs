use self::{
    annealing::{binarygraph::BinaryGraph, state::State},
    checker::{try_generate_isompic_graphs, IsomophicChecker, Vf2Checker},
};
use super::Encoder;
use crate::{
    encoders::isomorphism::annealing::annealer::Annealer,
    graph::Graph,
    utils::{decode_hex_to_u64, ChangeMinMax},
};
use rand_pcg::Pcg64Mcg;

mod annealing;
mod checker;

#[derive(Debug, Clone)]
pub struct IsomorphismEncoder {
    graphs: Vec<Graph>,
    /// 送信するグラフの種類数
    graph_count: usize,
    /// グラフの大きさ
    graph_size: usize,
    /// 冗長性考慮前のグラフの大きさ
    original_graph_size: usize,
    /// 冗長性
    redundancy: usize,
    /// 焼きなましスコアのグループ内:グループ外の重みの比
    score_coef: f64,
    /// 混同行列（使いやすいよう転置されている）
    confusing: Vec<Vec<u32>>,
}

impl IsomorphismEncoder {
    pub fn new(
        graph_count: usize,
        error_ratio: f64,
        bits: Option<usize>,
        redundancy: Option<usize>,
        score_coef: Option<f64>,
    ) -> Self {
        let (auto_bits, auto_redundancy, auto_score_coef) =
            Self::get_storategy(graph_count, error_ratio);

        let ((graphs, confusing), original_graph_size) = if let Some(bits) = bits {
            (
                try_generate_isompic_graphs(graph_count, error_ratio, bits).unwrap(),
                bits,
            )
        } else {
            (
                try_generate_isompic_graphs(graph_count, error_ratio, auto_bits).unwrap(),
                auto_bits,
            )
        };

        let redundancy = redundancy.unwrap_or(auto_redundancy);
        let score_coef = score_coef.unwrap_or(auto_score_coef);
        let graph_size = original_graph_size * redundancy;
        eprintln!("bits      : {}", original_graph_size);
        eprintln!("redundancy: {}", redundancy);
        eprintln!("score_coef: {}", score_coef);

        Self {
            graphs,
            graph_count,
            graph_size,
            original_graph_size,
            redundancy,
            score_coef,
            confusing,
        }
    }

    fn get_storategy(m: usize, error_ratio: f64) -> (usize, usize, f64) {
        let error_ratio = (error_ratio * 100.0 + 0.1) as usize;
        let storategy_matrix = get_storategy_matrix();
        storategy_matrix[m - 10][error_ratio]
    }

    fn restore(
        &self,
        graph: &BinaryGraph,
        annealer: &Annealer,
        duration: f64,
        rng: &mut Pcg64Mcg,
    ) -> Option<usize> {
        let state = State::init_rand(&graph, self.original_graph_size, self.score_coef, rng);
        let state = annealer.annealing(&graph, state, duration);
        let graph = state.restore_graph();
        let checker = Vf2Checker::new(&graph);

        for (i, g) in self.graphs.iter().enumerate() {
            if checker.is_isomorphic(g) {
                return Some(i);
            }
        }

        eprintln!("failed to decode.");
        None
    }
}

impl Encoder for IsomorphismEncoder {
    fn graph_size(&self) -> usize {
        self.graph_size
    }

    fn encode(&self, index: usize) -> Graph {
        let original_graph = &self.graphs[index];

        let mut graph = Graph::new(self.graph_size);
        // クリーク内
        for i in 0..original_graph.n {
            for x in 0..self.redundancy {
                for y in (x + 1)..self.redundancy {
                    let u = i * self.redundancy + x;
                    let v = i * self.redundancy + y;
                    graph.connect(u, v);
                }
            }
        }

        // クリーク間
        for i in 0..original_graph.n {
            for j in (i + 1)..original_graph.n {
                for x in 0..self.redundancy {
                    for y in 0..self.redundancy {
                        let u = i * self.redundancy + x;
                        let v = j * self.redundancy + y;
                        if original_graph[i][j] {
                            graph.connect(u, v);
                        }
                    }
                }
            }
        }

        graph
    }

    fn decode(&self, graph: &Graph, duration: f64) -> usize {
        let mut rng = Pcg64Mcg::new(42);
        let graph = BinaryGraph::new(graph);
        let annealer = Annealer::new(false);
        let mut votes = vec![0; self.graph_count];

        const TRIAL_COUNT: usize = 5;
        let each_duration = duration / TRIAL_COUNT as f64;

        // 多数決を取る
        for _ in 0..TRIAL_COUNT {
            if let Some(i) = self.restore(&graph, &annealer, each_duration, &mut rng) {
                for (j, &count) in self.confusing[i].iter().enumerate() {
                    votes[j] += count;
                }
            }
        }

        let mut max_votes = 0;
        let mut max_index = 0;

        for (i, &c) in votes.iter().enumerate() {
            if max_votes.change_max(c) {
                max_index = i;
            }
        }

        max_index
    }
}

fn get_storategy_matrix() -> Vec<Vec<(usize, usize, f64)>> {
    const HEX_DATA: &[u8] = b"4011401140214022402440314032403440334034404440444044404440544054405440644064406440644074408450714094409440a140a440b140c140c140e140e140f14121413151115142417141914191401140114024402240214031403140344043404240414044405450414054505240644064407450544074408450634091409440a240a140b440b140c140d150c150c141024101510160f1417241924171419150115024502450245032503450345034503450345034504150435042504450535054505450545063506150615071508150815081509150a150a150b150c150d150f350e150f151015111513151315141514150115024502450245032503450345034503450345034504150435042504450535054505450545063506150615071508150815081509150a150a150b150c150d150f350e150f151015111513151315141514150115024502450245032503450345034503450345034504150435042504450535054505450545063506150615071508150815081509150a150a150b150c150d150f350e150f151015111513151315141514150115024502450245032503450345034503450345034504150435042504450535054505450545063506150615071508150815081509150a150a150b150c150d150f350e150f151015111513151315141514150115024502450245032503450345034503450345034504150435042504450535054505450545063506150615071508150815081509150a150a150b150c150d150f350e150f151015111513151315141514150115024502450245032503450345034503450345034504150435042504450535054505450545063506150615071508150815081509150a150a150b150c150d150f350e150f151015111513151315141514150115024502450245032503450345034503450345034504150435042504450535054505450545063506150615071508150815081509150a150a150b150c150d150f350e150f151015111513151315141514150115024502450245032503450345034503450345034504150435042504450535054505450545063506150615071508150815081509150a150a150b150c150d150f350e150f151015111513151315141514150115024502450245032503450345034503450345034504150435042504450535054505450545063506150615071508150815081509150a150a150b150c150d150f350e150f15101511151315131514151415011502350235024503150345034503450345041504350435041504250435054505450545054506250645071507250815091509150a350a150a150b150c150e250f260e160e15132511151215131514151425011502350235024503150345034503450345041504350435041504250435054505450545054506250645071507250815091509150a350a150a150b150c150e250f260e160e15132511151215131514151425011502350235024503150345034503450345041504350435041504250435054505450545054506250645071507250815091509150a350a150a150b150c150e250f260e160e15132511151215131514151425011502350235024503150345034503450345041504350435041504250435054505450545054506250645071507250815091509150a350a150a150b150c150e250f260e160e15132511151215131514151425011502350235024503150345034503450345041504350435041504250435054505450545054506250645071507250815091509150a350a150a150b150c150e250f260e160e15132511151215131514151425011502150225024502450315034503150345041504350435042504250545054505450545063506150715074507450815091509150a150a150b150c150c150c160d160e160f15132610151325141514151425011502150225024502450315034503150345041504350435042504250545054505450545063506150715074507450815091509150a150a150b150c150c150c160d160e160f15132610151325141514151425011502150225024502450315034503150345041504350435042504250545054505450545063506150715074507450815091509150a150a150b150c150c150c160d160e160f15132610151325141514151425011502150215024503150315031503450345044504450445044504150545054505450545064506450746063606250815091509150a150a150b150b150c260c160d160e160e160f1610151425142513151425011502150215024503150315031503450345044504450445044504150545054505450545064506450746063606250815091509150a150a150b150b150c260c160d160e160e160f1610151425142513151425011502450225022503150345031503450345044504150445044604150545054505450615064506350746064606350815084509150a150a150b150b150c260c160d160e160f160f16101610151425141514250115021502250245031503450345034503450345041504450446041505450545054505450635064507160625081508150915091509150a150b150c260b160c160d160e160e16102610161015141514251425011502150215021503150345032503450345044504450445044604160415061506450615064507450716063606350815083509150a150a150b160b160b160c160d160e161026101610161015142514151425011502350215022503150315031504250416034603460426044604450546052605450616052605160636061606150816073608150a150a160a160b160c160c160d160e160f160f16101610161015141514260116021602460246032603160346034603460346042604360426042604160416054605460546053606160616061607460746081609160a160a160b160b160c160d160e1610260f16101610161016101610260116021602460246032603160346034603460346042604360426042604160416054605460546053606160616061607460746081609160a160a160b160b160c160d160e1610260f16101610161016101610260116021602460246032603160346034603460346042604360426042604160416054605460546053606160616061607460746081609160a160a160b160b160c160d160e1610260f16101610161016101610260116021602460246032603160346034603460346042604360426042604160416054605460546053606160616061607460746081609160a160a160b160b160c160d160e1610260f16101610161016101610260116021602460246032603160346034603460346042604360426042604160416054605460546053606160616061607460746081609160a160a160b160b160c160d160e1610260f16101610161016101610260116021602460246032603160346034603460346042604360426042604160416054605460546053606160616061607460746081609160a160a160b160b160c160d160e1610260f16101610161016101610260116021602160246031603160346034603460346034604260416041604360526054605460546054606460616072608160816081609160a160a160b160b160d160d1610260f160f16101610161016101610260116021602160246031603160346034603460346034604260416041604360526054605460546054606460616072608160816081609160a160a160b160b160d160d1610260f160f16101610161016101610260116021602160246031603160346034603460346034604260416041604360526054605460546054606460616072608160816081609160a160a160b160b160d160d1610260f160f16101610161016101610260116021602160246031603160346034603460346034604260416041604360526054605460546054606460616072608160816081609160a160a160b160b160d160d1610260f160f16101610161016101610260116021602160246031603160346034603460346034604260416041604360526054605460546054606460616072608160816081609160a160a160b160b160d160d1610260f160f16101610161016101610260116021602160246031603160346034603460346034604260416041604360526054605460546054606460616072608160816081609160a160a160b160b160d160d1610260f160f16101610161016101610260116021602160246031603160346034603460346034604260416041604360526054605460546054606460616072608160816081609160a160a160b160b160d160d1610260f160f16101610161016101610260116021602160246031603160346034603460346034604260416041604360526054605460546054606460616072608160816081609160a160a160b160b160d160d1610260f160f16101610161016101610260116021602160246031603160346034603460346034604260416041604360526054605460546054606460616072608160816081609160a160a160b160b160d160d1610260f160f16101610161016101610260116021602160246031603160346034603460346034604260416041604360526054605460546054606460616072608160816081609160a160a160b160b160d160d1610260f160f16101610161016101610260116023602460246034603460346032603460346041604260416041604160526054605460546062606460616063608160816083609160a160a160b160b160c160d16103610260f16101610161016101610260116023602460246034603460346032603460346041604260416041604160526054605460546062606460616063608160816083609160a160a160b160b160c160d16103610260f16101610161016101610260116023602460246034603460346032603460346041604260416041604160526054605460546062606460616063608160816083609160a160a160b160b160c160d16103610260f16101610161016101610260116023602460246034603460346032603460346041604260416041604160526054605460546062606460616063608160816083609160a160a160b160b160c160d16103610260f16101610161016101610260116023602460246034603460346032603460346041604260416041604160526054605460546062606460616063608160816083609160a160a160b160b160c160d16103610260f16101610161016101610260116023602460246034603460346032603460346041604260416041604160526054605460546062606460616063608160816083609160a160a160b160b160c160d16103610260f16101610161016101610260116023602460246034603460346032603460346041604260416041604160526054605460546062606460616063608160816083609160a160a160b160b160c160d16103610260f16101610161016101610260116023602460246034603460346032603460346041604260416041604160526054605460546062606460616063608160816083609160a160a160b160b160c160d16103610260f16101610161016101610260116023602460246034603460346032603460346041604260416041604160526054605460546062606460616063608160816083609160a160a160b160b160c160d16103610260f16101610161016101610260116023602460246034603460346032603460346041604260416041604160526054605460546062606460616063608160816083609160a160a160b160b160c160d16103610260f16101610161016101610260116021602360246031603160346034603460346041604160426041604460546054606360646064606460626073608160816081609160a160a160b160c160c160d16102610260f16101610161016101610360116021602360246031603160346034603460346041604160426041604460546054606360646064606460626073608160816081609160a160a160b160c160c160d16102610260f16101610161016101610360116021602360246031603160346034603460346041604160426041604460546054606360646064606460626073608160816081609160a160a160b160c160c160d16102610260f16101610161016101610360116021602360246031603160346034603460346041604160426041604460546054606360646064606460626073608160816081609160a160a160b160c160c160d16102610260f16101610161016101610360116021602360246031603160346034603460346041604160426041604460546054606360646064606460626073608160816081609160a160a160b160c160c160d16102610260f16101610161016101610360116021602360246031603160346034603460346041604160426041604460546054606360646064606460626073608160816081609160a160a160b160c160c160d16102610260f16101610161016101610360116021602360246031603160346034603460346041604160426041604460546054606360646064606460626073608160816081609160a160a160b160c160c160d16102610260f16101610161016101610360116021602360246031603160346034603460346041604160426041604460546054606360646064606460626073608160816081609160a160a160b160c160c160d16102610260f16101610161016101610360116021602360246031603160346034603460346041604160426041604460546054606360646064606460626073608160816081609160a160a160b160c160c160d16102610260f16101610161016101610360116021602360246031603160346034603460346041604160426041604460546054606360646064606460626073608160816081609160a160a160b160c160c160d16102610260f16101610161016101610360116022602460316031603160346034603460346041604160426041604160516054605460546061606260716073608160816081609160a160a160b160c160c160d160e1610261016101610161016102610260116022602460316031603160346034603460346041604160426041604160516054605460546061606260716073608160816081609160a160a160b160c160c160d160e1610261016101610161016102610260116022602460316031603160346034603460346041604160426041604160516054605460546061606260716073608160816081609160a160a160b160c160c160d160e1610261016101610161016102610260116022602460316031603160346034603460346041604160426041604160516054605460546061606260716073608160816081609160a160a160b160c160c160d160e1610261016101610161016102610260116022602460316031603160346034603460346041604160426041604160516054605460546061606260716073608160816081609160a160a160b160c160c160d160e1610261016101610161016102610260116022602460316031603160346034603460346041604160426041604160516054605460546061606260716073608160816081609160a160a160b160c160c160d160e1610261016101610161016102610260116022602460316031603160346034603460346041604160426041604160516054605460546061606260716073608160816081609160a160a160b160c160c160d160e1610261016101610161016102610260116022602460316031603160346034603460346041604160426041604160516054605460546061606260716073608160816081609160a160a160b160c160c160d160e1610261016101610161016102610260116022602460316031603160346034603460346041604160426041604160516054605460546061606260716073608160816081609160a160a160b160c160c160d160e1610261016101610161016102610260116022602460316031603160346034603460346041604160426041604160516054605460546061606260716073608160816081609160a160a160b160c160c160d160e1610261016101610161016102610260116021602360246031603160346034603460346041604260416042605260526054605460546062606160646071608160816091609160a160a160b160b160e360e260f2610260f16101610161016103610260116021602360246031603160346034603460346041604260416042605260526054605460546062606160646071608160816091609160a160a160b160b160e360e260f2610260f16101610161016103610260116021602360246031603160346034603460346041604260416042605260526054605460546062606160646071608160816091609160a160a160b160b160e360e260f2610260f16101610161016103610260116021602360246031603160346034603460346041604260416042605260526054605460546062606160646071608160816091609160a160a160b160b160e360e260f2610260f16101610161016103610260116021602360246031603160346034603460346041604260416042605260526054605460546062606160646071608160816091609160a160a160b160b160e360e260f2610260f16101610161016103610260116021602360246031603160346034603460346041604260416042605260526054605460546062606160646071608160816091609160a160a160b160b160e360e260f2610260f16101610161016103610260116021602360246031603160346034603460346041604260416042605260526054605460546062606160646071608160816091609160a160a160b160b160e360e260f2610260f16101610161016103610260116021602360246031603160346034603460346041604260416042605260526054605460546062606160646071608160816091609160a160a160b160b160e360e260f2610260f16101610161016103610260116021602360246031603160346034603460346041604260416042605260526054605460546062606160646071608160816091609160a160a160b160b160e360e260f2610260f16101610161016103610260116021602360246031603160346034603460346041604260416042605260526054605460546062606160646071608160816091609160a160a160b160b160e360e260f2610260f16101610161016103610260116024602460316034603160346031603460326041604160436041604160546054605460546062606160646073608160816091609160a160a160b160c260c160f260f2610261016101610161016102610360116024602460316034603160346031603460326041604160436041604160546054605460546062606160646073608160816091609160a160a160b160c260c160f260f2610261016101610161016102610360116024602460316034603160346031603460326041604160436041604160546054605460546062606160646073608160816091609160a160a160b160c260c160f260f2610261016101610161016102610360116024602460316034603160346031603460326041604160436041604160546054605460546062606160646073608160816091609160a160a160b160c260c160f260f2610261016101610161016102610360116024602460316034603160346031603460326041604160436041604160546054605460546062606160646073608160816091609160a160a160b160c260c160f260f2610261016101610161016102610360116024602460316034603160346031603460326041604160436041604160546054605460546062606160646073608160816091609160a160a160b160c260c160f260f2610261016101610161016102610360116024602460316034603160346031603460326041604160436041604160546054605460546062606160646073608160816091609160a160a160b160c260c160f260f2610261016101610161016102610360116024602460316034603160346031603460326041604160436041604160546054605460546062606160646073608160816091609160a160a160b160c260c160f260f2610261016101610161016102610360116024602460316034603160346031603460326041604160436041604160546054605460546062606160646073608160816091609160a160a160b160c260c160f260f2610261016101610161016102610360116024602460316034603160346031603460326041604160436041604160546054605460546062606160646073608160816091609160a160a160b160c260c160f260f26102610161016101610161026103";

    let mut matrix = vec![];
    let mut cursor = 0;

    for _m in 10..=100 {
        let mut line = vec![];
        for _eps in 0..=40 {
            let bits = decode_hex_to_u64(&HEX_DATA[cursor..(cursor + 1)]) as usize;
            cursor += 1;
            let redundancy = decode_hex_to_u64(&HEX_DATA[cursor..(cursor + 2)]) as usize;
            cursor += 2;
            // (score_coef - 1) * 4 を格納している
            let score_coef = decode_hex_to_u64(&HEX_DATA[cursor..(cursor + 1)]) as f64 * 0.25 + 1.0;
            cursor += 1;
            line.push((bits, redundancy, score_coef));
        }
        matrix.push(line)
    }

    matrix
}
